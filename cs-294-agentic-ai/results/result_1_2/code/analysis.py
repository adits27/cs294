"""Reproducible analysis code for RCT.

This code was auto-generated by the LLM-powered White Agent.
It reproduces the analysis performed on the experimental data.
"""

import pandas as pd
import numpy as np
from scipy import stats
from sklearn.linear_model import LinearRegression
from pathlib import Path

# Load data
data_path = Path(__file__).parent.parent / "data_source" / "data.csv"

# Try different loaders based on file extension
if data_path.suffix == '.csv':
    df = pd.read_csv(data_path)
elif data_path.suffix == '.parquet':
    df = pd.read_parquet(data_path)
elif data_path.suffix == '.json':
    df = pd.read_json(data_path)
elif data_path.suffix in ['.xlsx', '.xls']:
    df = pd.read_excel(data_path)
else:
    raise ValueError(f"Unsupported file format: {data_path.suffix}")

print(f"Loaded data with shape: {df.shape}")
print(f"Columns: {df.columns.tolist()}")

# Variable identification (from LLM analysis)
treatment_col = "treatment"
outcome_col = "student_id"
treatment_value = '1'
control_value = '0'

print(f"\nTreatment variable: {treatment_col}")
print(f"Outcome variable: {outcome_col}")
print(f"Treatment value: {treatment_value}, Control value: {control_value}")

# Separate treatment and control groups
control_data = df[df[treatment_col] == control_value][outcome_col].dropna()
treatment_data = df[df[treatment_col] == treatment_value][outcome_col].dropna()

print(f"\nControl group size: {len(control_data)}")
print(f"Treatment group size: {len(treatment_data)}")

# Calculate Average Treatment Effect (ATE)
control_mean = control_data.mean()
treatment_mean = treatment_data.mean()
ate = treatment_mean - control_mean

# Calculate standard errors
se_control = control_data.sem()
se_treatment = treatment_data.sem()
se_ate = np.sqrt(se_control**2 + se_treatment**2)

# Calculate 95% confidence intervals
ci_lower = ate - 1.96 * se_ate
ci_upper = ate + 1.96 * se_ate

# Perform t-test
t_stat, p_value = stats.ttest_ind(treatment_data, control_data)

# Calculate effect size (Cohen's d)
pooled_std = np.sqrt(
    ((len(control_data) - 1) * control_data.std()**2 +
     (len(treatment_data) - 1) * treatment_data.std()**2) /
    (len(control_data) + len(treatment_data) - 2)
)
cohens_d = ate / pooled_std if pooled_std > 0 else 0

# Print results
print("\n" + "="*60)
print("ANALYSIS RESULTS")
print("="*60)
print(f"\nControl mean: {control_mean:.4f}")
print(f"Treatment mean: {treatment_mean:.4f}")
print(f"\nAverage Treatment Effect (ATE): {ate:.4f}")
print(f"Standard Error: {se_ate:.4f}")
print(f"95% Confidence Interval: [{ci_lower:.4f}, {ci_upper:.4f}]")
print(f"\nt-statistic: {t_stat:.4f}")
print(f"p-value: {p_value:.4f}")
print(f"Statistically significant (Î±=0.05): {p_value < 0.05}")
print(f"\nEffect size (Cohen's d): {cohens_d:.4f}")

# Simple regression
X = df[[treatment_col]].values
y = df[outcome_col].values
model = LinearRegression()
model.fit(X, y)

print(f"\nRegression coefficient: {model.coef_[0]:.4f}")
print(f"R-squared: {model.score(X, y):.4f}")

print("\nAnalysis complete!")
